name: Pull Request Cleanup

on:
  pull_request:
    types: [closed]

jobs:
  delete-image:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Delete image from Container Registry
        uses: actions/github-script@v7
        with:
          script: |
            const packageName = 'service-foundry-web';
            const tag = `pr-${context.issue.number}`;
            const owner = context.repo.owner;
            console.log(`Searching for ${packageName}:${tag} in ${owner}...`);

            // Helper to list versions (handles pagination if needed, but taking first page for now)
            async function getVersions(isOrg) {
              if (isOrg) {
                return await github.rest.packages.getAllPackageVersionsForPackageOwnedByOrg({
                  package_type: 'container',
                  package_name: packageName,
                  org: owner,
                  state: 'active'
                });
              } else {
                return await github.rest.packages.getAllPackageVersionsForPackageOwnedByUser({
                  package_type: 'container',
                  package_name: packageName,
                  username: owner,
                  state: 'active'
                });
              }
            }

            try {
              // Determine if owner is Org or User
              // The API call usually depends on the account type.
              // We can check the repository owner type.
              const { data: repo } = await github.rest.repos.get({
                owner: owner,
                repo: context.repo.repo
              });
              
              const isOrg = repo.owner.type === 'Organization';
              console.log(`Owner type: ${repo.owner.type}`);

              const { data: versions } = await getVersions(isOrg);

              // Find the version with the matching tag
              const version = versions.find(v => v.metadata.container.tags.includes(tag));

              if (version) {
                console.log(`Found version ${version.id} with tag ${tag}. Deleting...`);
                
                if (isOrg) {
                  await github.rest.packages.deletePackageVersionForOrg({
                    package_type: 'container',
                    package_name: packageName,
                    org: owner,
                    package_version_id: version.id
                  });
                } else {
                  await github.rest.packages.deletePackageVersionForUser({
                    package_type: 'container',
                    package_name: packageName,
                    username: owner,
                    package_version_id: version.id
                  });
                }
                console.log('Version deleted successfully.');
              } else {
                console.log(`No version found with tag ${tag}. Nothing to delete.`);
              }
            } catch (error) {
              console.error(error);
              core.setFailed(`Failed to delete image: ${error.message}`);
            }
